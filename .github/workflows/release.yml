name: build-and-release

on:
    workflow_dispatch:
        inputs:
            version:
                description: "release version (e.g v2.0.0)"
                required: true
                type: string
            build_target:
                description: "build target"
                required: true
                default: "both"
                type: choice
                options:
                    - "both"
                    - "linux-only"
                    - "windows-only"
            action_type:
                description: "action type"
                required: true
                default: "draft"
                type: choice
                options:
                    - "draft"
                    - "publish"
                    - "build-only"
            changelog_override:
                description: "override existing release changelog"
                required: false
                default: false
                type: boolean
            update_only:
                description: "only update release description (skip build/upload)"
                required: false
                default: false
                type: boolean
            include_versions:
                description: "additional versions to include in changelog (comma-separated, e.g. v2.1.1,v2.1.0)"
                required: false
                type: string

jobs:
    prepare:
        runs-on: ubuntu-latest
        outputs:
            exists: ${{ steps.check_release.outputs.exists }}
            notes: ${{ steps.extract_notes.outputs.notes }}
            should_build: ${{ steps.check_release.outputs.should_build }}
            should_create_release: ${{ steps.check_release.outputs.should_create_release }}
        steps:
            - name: checkout
              uses: actions/checkout@v6

            - name: setup bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: check if release exists
              id: check_release
              run: |
                  echo "[log] checking if release ${{ github.event.inputs.version }} exists..."

                  if gh release view "${{ github.event.inputs.version }}" > /dev/null 2>&1; then
                    echo "exists=true" >> $GITHUB_OUTPUT
                    echo "[log] release already exists."

                    if [[ "${{ github.event.inputs.update_only }}" == "true" ]]; then
                      echo "should_build=false" >> $GITHUB_OUTPUT
                      echo "should_create_release=true" >> $GITHUB_OUTPUT
                      echo "[log] update_only mode - will skip build but update release."
                    elif [[ "${{ github.event.inputs.changelog_override }}" == "true" ]]; then
                      echo "should_build=true" >> $GITHUB_OUTPUT
                      echo "should_create_release=true" >> $GITHUB_OUTPUT
                      echo "[log] override enabled - will rebuild and update release."
                    else
                      echo "should_build=false" >> $GITHUB_OUTPUT
                      echo "should_create_release=false" >> $GITHUB_OUTPUT
                      echo "[log] release exists and no override - workflow will stop."
                      exit 1
                    fi
                  else
                    echo "exists=false" >> $GITHUB_OUTPUT

                    if [[ "${{ github.event.inputs.update_only }}" == "true" ]]; then
                      echo "[error] cannot use update_only when release doesn't exist"
                      exit 1
                    fi

                    echo "should_build=true" >> $GITHUB_OUTPUT
                    echo "should_create_release=true" >> $GITHUB_OUTPUT
                    echo "[log] release doesn't exist - will build and create."
                  fi
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: extract notes
              id: extract_notes
              run: |
                  bun run scripts/changelog.ts "${{ github.event.inputs.version }}" "${{ github.event.inputs.include_versions }}" "changelog_output.tmp"

                    if [[ -f "changelog_output.tmp" ]]; then
                        encoded=$(base64 -w 0 changelog_output.tmp)
                        echo "notes=$encoded" >> $GITHUB_OUTPUT
                    fi

    build_linux:
        needs: [prepare]
        runs-on: ubuntu-latest
        if: |
            needs.prepare.outputs.should_build == 'true' &&
            (github.event.inputs.build_target == 'both' || github.event.inputs.build_target == 'linux-only')
        env:
            GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        steps:
            - name: checkout
              uses: actions/checkout@v6

            - name: setup bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: setup node
              uses: actions/setup-node@v6
              with:
                  node-version: 24

            - name: install system dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y dpkg-dev build-essential libsndfile1-dev libmp3lame-dev
                  mkdir -p /usr/local/bin
                  curl -L https://github.com/AppImage/appimagetool/releases/download/continuous/appimagetool-x86_64.AppImage -o /usr/local/bin/appimagetool
                  chmod +x /usr/local/bin/appimagetool

            - name: install dependencies
              run: bun install

            - name: build linux app
              run: bun run build:linux

            - name: upload linux artifacts
              uses: actions/upload-artifact@v6
              with:
                  name: linux-build
                  path: |
                      dist/*.AppImage
                      dist/*.deb

    build_windows:
        needs: [prepare]
        runs-on: windows-latest
        if: |
            needs.prepare.outputs.should_build == 'true' &&
            (github.event.inputs.build_target == 'both' || github.event.inputs.build_target == 'windows-only')
        env:
            GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        steps:
            - name: checkout
              uses: actions/checkout@v6

            - name: setup bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: setup node
              uses: actions/setup-node@v6
              with:
                  node-version: 24

            - name: install dependencies
              run: bun install

            - name: build windows app
              run: bun run build:win

            - name: upload windows artifacts
              uses: actions/upload-artifact@v6
              with:
                  name: windows-build
                  path: |
                      dist/*.exe

    create_release:
        needs: [prepare, build_linux, build_windows]
        runs-on: ubuntu-latest
        if: |
            always() &&
            needs.prepare.outputs.should_create_release == 'true' &&
            (needs.build_linux.result == 'success' || needs.build_linux.result == 'skipped') &&
            (needs.build_windows.result == 'success' || needs.build_windows.result == 'skipped') &&
            (github.event.inputs.action_type == 'draft' || github.event.inputs.action_type == 'publish')
        steps:
            - name: download linux artifacts
              if: needs.build_linux.result == 'success'
              uses: actions/download-artifact@v7
              with:
                  name: linux-build
                  path: artifacts/

            - name: download windows artifacts
              if: needs.build_windows.result == 'success'
              uses: actions/download-artifact@v7
              with:
                  name: windows-build
                  path: artifacts/

            - name: list artifacts
              run: |
                  echo "[log] listing artifacts directory:"
                  ls -la artifacts/ || echo "[log] no artifacts directory found"

            - name: create or update release
              uses: softprops/action-gh-release@v2
              with:
                  name: ${{ github.event.inputs.version }}
                  tag_name: ${{ github.event.inputs.version }}
                  draft: ${{ github.event.inputs.action_type == 'draft' }}
                  prerelease: ${{ github.event.inputs.action_type == 'draft' }}
                  generate_release_notes: ${{ needs.prepare.outputs.notes == '' }}
                  body: ${{ base64 --decode <<< needs.prepare.outputs.notes }}
                  files: artifacts/*
                  token: ${{ secrets.GITHUB_TOKEN }}
