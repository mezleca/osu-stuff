name: build-and-release

on:
    workflow_dispatch:
        inputs:
            version:
                description: "release version (e.g v2.0.0)"
                required: true
                type: string
            build_target:
                description: "build target"
                required: true
                default: "both"
                type: choice
                options:
                    - "both"
                    - "linux-only"
                    - "windows-only"
            action_type:
                description: "action type"
                required: true
                default: "draft"
                type: choice
                options:
                    - "draft"
                    - "publish"
                    - "build-only"

jobs:
    build:
        strategy:
            matrix:
                include:
                    - os: ubuntu-latest
                      platform: linux
                      should_run: ${{ github.event.inputs.build_target == 'both' || github.event.inputs.build_target == 'linux-only' }}
                      artifact_patterns: |
                          dist/*.AppImage
                          dist/*.deb
                    - os: windows-latest
                      platform: windows
                      should_run: ${{ github.event.inputs.build_target == 'both' || github.event.inputs.build_target == 'windows-only' }}
                      artifact_patterns: |
                          dist/*.exe

        runs-on: ${{ matrix.os }}

        if: ${{ matrix.should_run == 'true' }}

        env:
            GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

        steps:
            - name: checkout
              uses: actions/checkout@v6

            - name: setup bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: install system dependencies (linux)
              if: matrix.platform == 'linux'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y dpkg-dev build-essential libsndfile1-dev libmp3lame-dev
                  mkdir -p /usr/local/bin
                  curl -L https://github.com/AppImage/appimagetool/releases/download/continuous/appimagetool-x86_64.AppImage -o /usr/local/bin/appimagetool
                  chmod +x /usr/local/bin/appimagetool

            - name: setup MSVC
              if: matrix.platform == 'windows'
              uses: ilammy/msvc-dev-cmd@v1

            - name: install vcpkg dependencies (windows)
              if: matrix.platform == 'windows'
              run: vcpkg install libsndfile[core,mpeg,external-libs]:x64-windows-static

            - name: install dependencies
              run: bun install

            - name: build app
              run: |
                  if [ "${{ matrix.platform }}" == "linux" ]; then
                    bun run build:linux
                  else
                    bun run build:win
                  fi
              shell: bash

            - name: upload artifacts
              uses: actions/upload-artifact@v5
              with:
                  name: ${{ matrix.platform }}-build
                  path: ${{ matrix.artifact_patterns }}

    create-release:
        needs: build
        runs-on: ubuntu-latest

        if: |
            always() &&
            !cancelled() &&
            (github.event.inputs.action_type == 'draft' || github.event.inputs.action_type == 'publish')

        steps:
            - name: checkout
              uses: actions/checkout@v6

            - name: get version
              id: get_version
              run: echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT

            - name: download artifacts
              uses: actions/download-artifact@v6
              with:
                  path: artifacts/
                  merge-multiple: true

            - name: create draft release
              if: github.event.inputs.action_type == 'draft'
              uses: softprops/action-gh-release@v2
              with:
                  name: ${{ steps.get_version.outputs.VERSION }}
                  tag_name: ${{ steps.get_version.outputs.VERSION }}
                  draft: true
                  prerelease: true
                  generate_release_notes: true
                  files: |
                      ./artifacts/*.AppImage
                      ./artifacts/*.deb
                      ./artifacts/*.exe
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: create published release
              if: github.event.inputs.action_type == 'publish'
              uses: softprops/action-gh-release@v2
              with:
                  name: ${{ steps.get_version.outputs.VERSION }}
                  tag_name: ${{ steps.get_version.outputs.VERSION }}
                  draft: false
                  prerelease: false
                  generate_release_notes: true
                  files: |
                      ./artifacts/*.AppImage
                      ./artifacts/*.deb
                      ./artifacts/*.exe
                  token: ${{ secrets.GITHUB_TOKEN }}
